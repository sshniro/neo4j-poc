
<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
    <title>graph-results</title>
    <link rel="stylesheet" href="./css/popoto.min.css">
    <link rel="stylesheet" href="./css/vis.min.css">
    <link rel="stylesheet" href="./css/custom.css">
</head>
<body>
<div id="popoto-taxonomy" class="drawer">
    <h5>Node labels</h5>
    <!-- Label/taxonomy filter will be generated here -->
</div>
<div id="main" class="main">
    <div class="notice-bar">
        Popoto.js customization example using <a href="http://visjs.org/" style="color: #0ebcff;">vis.js</a> to display results as graph.
    </div>
    <div class="frame" id="popoto-graph">
        <!-- Graph will be generated here-->
    </div>
    <div class="code-bar" id="popoto-cypher">
    </div>
    <div class="frame" id="vis">
        <!-- Results visualization will be generated here -->
    </div>
</div>
<!-- Required scripts -->
<script src="./js/jquery-2.1.0.min.js" charset="utf-8"></script>
<script src="./js/d3.v3.min.js" charset="utf-8"></script>
<script src="./js/popoto.min.js" charset="utf-8"></script>
<script src="./js/vis.min.js"></script>
<script>

    function UrlExists(url)
    {
        var http = new XMLHttpRequest();
        http.open('HEAD', url, false);
        http.send();
        return http.status!=404;
    }

    // Change ellipses dimension to have circles
    popoto.graph.node.ELLIPSE_RX = 40;
    popoto.graph.node.ELLIPSE_RY = 40;
    popoto.graph.node.TEXT_Y = 6;
    popoto.graph.LINK_DISTANCE = 150;
    popoto.graph.node.BACK_CIRCLE_R = 48;

    // Disable toggle taxonomy tool button
    popoto.tools.TOGGLE_TAXONOMY = false;

//    popoto.rest.CYPHER_URL = "http://www.popotojs.com/proxy.php";
    popoto.rest.CYPHER_URL = "http://localhost:7474/db/data/transaction/commit";
    popoto.rest.AUTHORIZATION = "Basic " + btoa("neo4j:nIro");

    popoto.graph.node.NODE_MAX_CHARS = 13;

    // Define the list of label provider to customize the graph behavior:
    popoto.provider.nodeProviders = {
        "Position": {
            "returnAttributes": ["name"],
            "constraintAttribute": "name",
//            "autoExpandRelations": true,
//            "getPredefinedConstraints": function (node) {
//                return positionPredifinedConstraints;
//            },
        },
        "Team": {
            "returnAttributes": ["name"],
            "constraintAttribute": "name",
//            "autoExpandRelations": true,
        },
        "Team": {
            "returnAttributes": ["name"],
            "constraintAttribute": "name",
//            "autoExpandRelations": true,
        },
        "Employee": {
            "returnAttributes": ["name"],
            "constraintAttribute": "name",
            "autoExpandRelations": true,
            "getDisplayType": function (node) {
                return popoto.provider.NodeDisplayTypes.IMAGE;
            },
            "getImagePath": function (node) {
                var path = "./image/employee/person_green.svg";
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    path = "./image/employee/" + node.attributes.name + ".gif"
                    if(!UrlExists(path)) {
                        path = "./image/employee/person_green.svg";
                    }
                } else {
                    if (node.value !== undefined) {
                        path = "./image/employee/" + node.value.attributes.name + ".gif"
                        if(!UrlExists(path)) {
                            path = "./image/employee/person_green.svg";
                        }
                    } else {
                        if (node.type === popoto.graph.node.NodeTypes.ROOT) {
                            path = "./image/employee/person_blue.svg";
                        } else {
                            if (node.count == 0) {
                                path = "./image/employee/person_disabled.svg";
                            } else {
                                path = "./image/employee/person_green.svg";
                            }
                        }
                    }
                }
//                path = "./image/employee/test.GIF";
                return path;
            },
            "getImageWidth": function (node) {
                var min = 50;
                var max = 175;
                var size = 125;

                if (node.hasOwnProperty("count")) {
                    size = node.count * 20; // better calculate size here

                    if (size < min) {
                        size = min;
                    }
                    if (size > max) {
                        size = max;
                    }
                }

                return size;
            },
            "getImageHeight": function (node) {
                var min = 50;
                var max = 175;
                var size = 125;

                if (node.hasOwnProperty("count")) {
                    size = node.count * 20; // better calculate size here

                    if (size < min) {
                        size = min;
                    }
                    if (size > max) {
                        size = max;
                    }
                }

                return size;
            },
            "displayResults": function (pResultElmt) {
//                console.log(pResultElmt);
            },
            "getIsTextDisplayed": function (node) {
                return false;
            },

        },
        "Skills": {
            "returnAttributes": ["name"],
            "constraintAttribute": "name",
            "autoExpandRelations": true
        },
        "Vehicle": {
            "returnAttributes": ["name"],
            "constraintAttribute": "name",
            "autoExpandRelations": true
        }
    };

    // Change the number of displayed results:
    popoto.query.RESULTS_PAGE_SIZE = 7;

    popoto.logger.LEVEL = popoto.logger.LogLevels.INFO;

    /**
     * Add a listener on result received to update map.
     */
//    popoto.result.onGraphResultReceived(
//        function (graphResultObject) {
//
//            var nodes = convertNodes(graphResultObject.nodes);
//            var edges = convertEdges(graphResultObject.edges);
//            var container = document.getElementById('vis');
//
//            // provide the data in the vis format
//            var data = {
//                nodes: nodes,
//                edges: edges
//            };
//            var options = {
//                nodes: {
//                    shape: 'circle',
//                    borderWidth: 2,
//                    size: 20,
//                    font: {
//                        size: 10,
//                        color: '#ffffff'
//                    }
//                },
//                edges: {
//                    length: 200,
//                    font: {
//                        align: 'top',
//                        size: 10
//                    },
//                    arrows: 'to'
//                },
//                groups: {
//                    "Person": {
//                        color: {background: '#68BDF6', border: '#5CA8DB'}
//                    },
//                    "Movie": {
//                        color: {background: '#FF756E', border: '#E06760'}
//                    }
//                }
//            };
//
//            // initialize the network
//            var network = new vis.Network(container, data, options);
//        }
//    );

//    function convertNodes(nodes) {
//        var convertedNodes = [];
//
//        nodes.forEach(function (node) {
//            var nodeLabel = node.labels[0];
//            convertedNodes.push({
//                id: node.id,
//                label: (nodeLabel == "Person" ? node.properties["name"] : node.properties["title"]),
//                group: nodeLabel
//            })
//        });
//
//        return convertedNodes;
//    }
//
//    function convertEdges(edges) {
//        var convertedEdges = [];
//
//        edges.forEach(function (edge) {
//            convertedEdges.push({
//                from: edge.startNode,
//                to: edge.endNode,
//                label: edge.type
//            })
//        });
//
//        return convertedEdges;
//    }

    // Start the generation using parameter as root label of the query.
    popoto.start("Employee");

</script>
</body>
</html>
